<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Trade Algo Bot — Signal Viewer</title>
<style>
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%}
  body{
    font-family: -apple-system, "Inter", "Segoe UI", Roboto, Arial, sans-serif;
    background: linear-gradient(180deg,#060718 0%, #040417 45%, #02030a 100%);
    color:#e6eef8;
    min-height:100vh;
    display:flex;align-items:center;justify-content:center;padding:12px;
  }
  .viewer{ width:100%; max-width:420px; background: linear-gradient(180deg, rgba(6,12,28,0.98), rgba(9,10,20,0.99)); border-radius:18px; box-shadow:0 30px 60px rgba(2,3,10,0.7); padding:18px; border:1px solid rgba(255,255,255,0.02); text-align:center; }
  .big-arrow { width:100%; height:320px; display:flex;align-items:center;justify-content:center; position:relative; }
  .big-arrow svg{ width:60%; height:auto; filter: drop-shadow(0 12px 40px rgba(0,0,0,0.6)); }
  .signal-msg { margin-top:10px; font-weight:900; font-size:18px; letter-spacing:0.6px; padding:8px 12px; border-radius:12px; display:inline-block; }
  .signal-up { background: linear-gradient(90deg,#0f7f4a,#34d399); color: #032614; }
  .signal-down { background: linear-gradient(90deg,#ff6b7a,#ff4d6d); color: #3a0610; }

  .controls{ margin-top:14px; display:flex; gap:8px; }
  .btn{ flex:1; padding:12px; border-radius:12px; border:none; font-weight:800; cursor:pointer; }
  .btn-primary{ background:linear-gradient(90deg,#5f2bff,#9a4dff); color:#fff; }
  .btn-ghost{ background:transparent; color:#9aa4bd; border:1px solid rgba(255,255,255,0.03); }

  .meta{ margin-top:10px; color:#9aa4bd; font-size:13px; }

  .hidden{ display:none; }
</style>
</head>
<body>
  <div class="viewer" id="viewer">
    <div style="font-weight:800;font-size:15px;color:#f3f6fb">Signal Viewer</div>
    <div style="font-size:12px;color:#7a86a8;margin-bottom:8px" id="descText">Shows last generated signal — admin-only control available via query param.</div>

    <div class="big-arrow" id="bigArrow">
      <!-- placeholder large arrow -->
      <svg id="arrowSVG" viewBox="0 0 140 90" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <path id="pathMain" d="M12 60 L55 18 L85 46 L128 8" stroke="#34D399" stroke-width="12" stroke-linecap="round" stroke-linejoin="round" fill="none" />
        <path id="pathHead" d="M124 12 L132 18 L118 20" stroke="#34D399" stroke-width="10" stroke-linecap="round" stroke-linejoin="round" fill="none" />
      </svg>
    </div>

    <div id="signalMsg" class="signal-msg">No signal yet</div>

    <div class="meta" id="meta">—</div>

    <div class="controls">
      <button id="genBtn" class="btn btn-primary">Generate (Admin)</button>
      <button id="backBtn" class="btn btn-ghost">Back</button>
    </div>

    <div id="adminNote" style="margin-top:8px;color:#9aa4bd;font-size:12px"></div>
  </div>

<script>
(function(){
  const qs = n => new URLSearchParams(location.search).get(n);
  const ADMIN_KEY_EXPECTED = 'CipherDev12$';
  function isAdmin(){ try{ if(qs('admin') === '1' && qs('admin_key') === ADMIN_KEY_EXPECTED){ localStorage.setItem('tradealgo_admin','1'); return true; } return localStorage.getItem('tradealgo_admin') === '1'; }catch(e){return false;}}

  const viewer = document.getElementById('viewer');
  const arrowSVG = document.getElementById('arrowSVG');
  const pathMain = document.getElementById('pathMain');
  const pathHead = document.getElementById('pathHead');
  const signalMsg = document.getElementById('signalMsg');
  const meta = document.getElementById('meta');
  const genBtn = document.getElementById('genBtn');
  const backBtn = document.getElementById('backBtn');
  const adminNote = document.getElementById('adminNote');

  function loadLastSignal(){
    try {
      const raw = localStorage.getItem('tradealgo_last_signal');
      if(!raw) return null;
      return JSON.parse(raw);
    } catch(e){ return null; }
  }

  function renderSignal(sigObj){
    if(!sigObj){
      signalMsg.textContent = 'No signal yet';
      meta.textContent = 'No cached signal available.';
      // neutral arrow color
      pathMain.setAttribute('stroke','#b0b0b0');
      pathHead.setAttribute('stroke','#b0b0b0');
      return;
    }
    const dir = sigObj.signal;
    const conf = sigObj.confidence;
    meta.textContent = `${sigObj.pair || '—'} · ${sigObj.tf || '—'} · Generated ${new Date(sigObj.ts).toLocaleString()}`;
    if(dir === 'UP'){
      pathMain.setAttribute('stroke','#34D399');
      pathHead.setAttribute('stroke','#34D399');
      signalMsg.textContent = `Your signal is UP — ${conf}%`;
      signalMsg.className = 'signal-msg signal-up';
    } else {
      pathMain.setAttribute('stroke','#ff5b74');
      pathHead.setAttribute('stroke','#ff5b74');
      signalMsg.textContent = `Your signal is DOWN — ${conf}%`;
      signalMsg.className = 'signal-msg signal-down';
    }
    // small animation: stroke-dasharray trick
    const total = pathMain.getTotalLength ? pathMain.getTotalLength() : 300;
    pathMain.style.strokeDasharray = total;
    pathMain.style.strokeDashoffset = total;
    pathMain.style.transition = 'stroke-dashoffset 700ms cubic-bezier(.2,.9,.36,1)';
    requestAnimationFrame(()=> { pathMain.style.strokeDashoffset = 0; });
  }

  // seed generator (same logic used in dashboard)
  function seeded(seedString){
    let seed = 0;
    for(let i=0;i<seedString.length;i++) seed = (seed*31 + seedString.charCodeAt(i)) % 1000000;
    return function(min,max){
      seed = (seed * 9301 + 49297) % 233280;
      const v = seed / 233280;
      return min + v*(max-min);
    };
  }
  function makeIndicators(seedStr){
    const r = seeded(seedStr);
    const indicators = {
      MACD: Number(r(-1.6,2.4).toFixed(2)),
      RSI: Math.round(r(30,88)),
      OBV_trend: Number(r(-1,1).toFixed(2)),
      EMA_diff: Number(r(-0.8,1.8).toFixed(2)),
      SAR_delta: Number(r(-0.6,0.9).toFixed(2)),
      Volatility: Number(r(0.6,2.6).toFixed(2)),
      VolumeStrength: Number(r(0.2,1.0).toFixed(2))
    };
    let score = 0;
    score += Math.max(0, indicators.MACD + 1) * 0.18;
    score += (Math.max(0, indicators.RSI - 40) / 50) * 0.18;
    score += ((indicators.OBV_trend + 1) / 2) * 0.15;
    score += (Math.max(0, indicators.EMA_diff + 0.8) / 2.6) * 0.14;
    score += (Math.max(0, indicators.SAR_delta + 0.6) / 1.5) * 0.12;
    const volScore = 1 - Math.abs(indicators.Volatility - 1.1) / 1.5;
    score += Math.max(0, volScore) * 0.12;
    score += indicators.VolumeStrength * 0.11;
    score = Math.max(0, Math.min(1, score / 1.05));
    const confidence = Math.round((0.79 + score * 0.17) * 100);
    return {indicators,score:Number((score*10).toFixed(2)),confidence};
  }
  function decideSignalFromIndicators(ind){
    const scoreComposite = (ind.MACD * 1.3) + (ind.OBV_trend * 1.2) + (ind.EMA_diff * 1.0) + ((ind.RSI - 50) / 30);
    return scoreComposite >= 0 ? 'UP' : 'DOWN';
  }

  // initial render
  const last = loadLastSignal();
  renderSignal(last);
  adminNote.textContent = isAdmin() ? 'Admin mode active. You can press Generate.' : '';

  // back
  backBtn.addEventListener('click', ()=> window.close());

  // generate (admin-only)
  genBtn.addEventListener('click', ()=>{
    if(!isAdmin()){
      alert('Admin required to generate. Open with ?admin=1&admin_key=CipherDev12$');
      return;
    }
    genBtn.disabled = true;
    genBtn.textContent = 'Generating...';
    setTimeout(()=>{
      const nowData = makeIndicators('SIGNAL|' + Date.now());
      const finalSignal = decideSignalFromIndicators(nowData.indicators);
      const payload = { pair: (qs('pair') || 'EURUSD'), tf:(qs('tf')||'5s'), signal: finalSignal, confidence: nowData.confidence, indicators: nowData.indicators, ts: Date.now() };
      try { localStorage.setItem('tradealgo_last_signal', JSON.stringify(payload)); }catch(e){}
      renderSignal(payload);
      genBtn.textContent = 'Generate (Admin)';
      genBtn.disabled = false;
    }, 850);
  });

})();
</script>
</body>
</html>
