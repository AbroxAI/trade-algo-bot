<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Trade Algo Bot — Signal</title>
<style>
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%}
  body{
    font-family: -apple-system, "SF Pro Text", "Inter", "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    background: linear-gradient(180deg,#060718 0%, #040417 45%, #02030a 100%);
    color:#e6eef8;
    min-height:100vh;
    display:flex;align-items:center;justify-content:center;padding:12px;
  }

  .app{ width:100%; max-width:420px; background: linear-gradient(180deg, rgba(6,12,28,0.98), rgba(9,10,20,0.99)); border-radius:18px; box-shadow:0 30px 60px rgba(2,3,10,0.7); padding:18px; border:1px solid rgba(255,255,255,0.02); position:relative; }

  .heading { text-align:center; font-weight:700; font-size:16px; margin-bottom:8px; color:#fff;}
  .subtext{ text-align:center;color:rgba(230,238,248,0.65); font-size:12px; margin-bottom:12px; }

  .card { background:#0a0d1d; border-radius:16px; border:1px solid #1a1f35; padding:16px; text-align:center; position:relative; }

  .pair-row { display:flex; align-items:center; justify-content:center; gap:10px; margin-bottom:6px; }
  .pair-flag { width:34px; height:24px; border-radius:6px; overflow:hidden; display:inline-block; border:1px solid rgba(255,255,255,0.03); box-shadow:0 8px 18px rgba(2,4,10,0.35); }
  .pair-title{ font-weight:800; font-size:16px; margin-bottom:4px; display:flex; align-items:center; gap:8px; justify-content:center; }
  .pair-meta{ font-size:12px; color:#7a86a8; margin-bottom:12px; opacity:0.95 }

  /* ring */
  .ring { width:140px;height:140px;border-radius:50%;margin:8px auto 8px;display:flex;align-items:center;justify-content:center; position:relative; filter: drop-shadow(0 8px 18px rgba(86,46,255,0.06)); }
  .ring .percent{ font-weight:800; font-size:20px; color:#b06bff; z-index:2; letter-spacing:0.6px; }
  .ring svg{ position:absolute; left:0; top:0; transform:rotate(-90deg); }

  /* rotating subtle background ring */
  .ring .bg-ring { stroke: #111429; stroke-width:8; fill:none; }
  .ring .fg-ring { stroke:#b06bff; stroke-width:8; stroke-linecap:round; fill:none; stroke-dasharray:326.7256; stroke-dashoffset:326.7256; transition: stroke-dashoffset 700ms cubic-bezier(.2,.9,.36,1); filter: drop-shadow(0 6px 18px rgba(176,107,255,0.08)); }

  /* indicators */
  .indicators{ display:flex; gap:8px; justify-content:center; margin-top:6px; margin-bottom:12px; flex-wrap:wrap }
  .ind-chip{ padding:6px 10px; border-radius:999px; background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02)); border:1px solid rgba(255,255,255,0.03); color:#fff; font-weight:700; font-size:12px; cursor:pointer; box-shadow: 0 8px 18px rgba(2,4,10,0.12); }
  .ind-chip.selected { background: linear-gradient(90deg,#17182b,#121224); color:#fff; box-shadow: 0 10px 28px rgba(60,20,140,0.12); }

  .btn-primary{ width:100%; padding:14px; border-radius:14px; border:none; font-weight:800; font-size:15px; color:#fff; cursor:pointer; background:linear-gradient(90deg,#5f2bff,#9a4dff); margin-bottom:12px; box-shadow: 0 6px 18px rgba(95,43,255,0.12); }
  .btn-ghost{ width:100%; padding:12px; border-radius:12px; border:1px solid #1a1f35; font-weight:700; font-size:14px; color:#7a86a8; background:transparent; cursor:pointer; }

  .powered{ text-align:center; font-size:11px; color:#5b6280; margin-top:10px; }

  /* arrow overlay (admin-only) */
  .arrow-overlay {
    position:absolute;
    left:50%;
    top:180px;
    transform:translateX(-50%);
    width:180px;
    height:120px;
    display:flex;
    align-items:center;
    justify-content:center;
    pointer-events:none;
    opacity:0;
    transition: opacity 260ms ease, transform 420ms cubic-bezier(.2,.9,.36,1);
    z-index:40;
  }
  .arrow-overlay.show { opacity:1; transform:translateX(-50%) translateY(-6px); }

  /* glowing label under the arrow */
  .signal-label {
    position:absolute;
    top:240px;
    left:50%;
    transform:translateX(-50%);
    z-index:41;
    font-weight:900;
    color:#ff6b6b;
    font-size:14px;
    letter-spacing:0.2px;
    padding:6px 10px;
    border-radius:8px;
    background: rgba(0,0,0,0.25);
    display:none;
  }
  .signal-label.up { color:#41f08a; box-shadow:0 6px 22px rgba(64,240,138,0.12); text-shadow: 0 2px 8px rgba(65,240,138,0.14); display:block; }
  .signal-label.down { color:#ff7f8a; box-shadow:0 6px 22px rgba(255,127,138,0.10); text-shadow: 0 2px 8px rgba(255,127,138,0.12); display:block; }

  /* admin panel */
  .admin-panel{
    margin-top:12px;
    background: linear-gradient(180deg,#071028,#061022);
    border-radius:12px;
    padding:10px;
    text-align:left;
    font-size:13px;
    color:#c8d2e6;
    border:1px solid rgba(255,255,255,0.02);
  }
  .admin-panel h4 { margin:0 0 8px 0; color:#f3f6fb; font-size:14px; font-weight:800; }
  .admin-row { display:flex; justify-content:space-between; gap:8px; padding:6px 0; border-bottom:1px dashed rgba(255,255,255,0.02); }
  .admin-row:last-child { border-bottom:0 }
  .admin-key { color:#9aa4bd; font-weight:700; }
  .admin-val { color:#fff; font-weight:800; }

  /* simple toggle */
  .toggle {
    display:inline-flex; align-items:center; gap:8px;
  }
  .toggle input{ display:none; }
  .toggle .knob{
    width:44px; height:26px; background:#111428; border-radius:16px; position:relative; border:1px solid rgba(255,255,255,0.03);
  }
  .toggle .dot { width:18px; height:18px; background:#b6bdf0; border-radius:50%; position:absolute; top:4px; left:4px; transition: all 220ms ease; box-shadow:0 6px 14px rgba(5,6,16,0.6); }
  .toggle input:checked + .knob { background: linear-gradient(90deg,#36d28f,#41f08a); border-color: rgba(65,240,138,0.22); }
  .toggle input:checked + .knob .dot { left:22px; background:#fff; }

  /* subscription modal */
  .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.75); backdrop-filter: blur(4px); justify-content:center; align-items:center; z-index:9999; }
  .modal .box{ background:#0b0f1e; color:#fff; padding:20px; border-radius:12px; width:92%; max-width:420px; border:1px solid #1f263b; text-align:center; box-shadow: 0 30px 60px rgba(2,3,10,0.7); }
  .modal h3{ font-size:18px; margin-bottom:8px; }
  .modal p{ color:#9aa4bd; font-size:13px; margin-bottom:14px; line-height:1.45; }
  .modal .actions{ display:flex; gap:8px; justify-content:center; margin-top:8px; }
  .modal .actions a, .modal .actions button{ flex:1; padding:10px; border-radius:10px; text-decoration:none; border:none; font-weight:800; cursor:pointer; }

  .disabled { opacity:0.55; pointer-events:none; }

  /* small responsive */
  @media (min-width:520px) {
    .modal .box { max-width:520px; }
    .arrow-overlay { top:168px; }
    .signal-label { top:230px; }
  }
</style>
</head>
<body>
  <div class="app" role="application" aria-label="Trading signal app">
    <div class="heading">Advanced Trading Signals</div>
    <div class="subtext">Pairs · Time · Signal</div>

    <div class="card" id="mainCard">
      <div class="pair-row">
        <div class="pair-flag" id="flag1Wrap"><img id="flag1Img" src="" alt="" style="width:100%;height:100%;object-fit:cover"></div>
        <div style="display:flex;flex-direction:column;align-items:center">
          <div class="pair-title" id="pairTitle">EUR / USD (OTC)</div>
          <div class="pair-meta" id="pairMeta">Live Signal · 5s Frame</div>
        </div>
        <div class="pair-flag" id="flag2Wrap"><img id="flag2Img" src="" alt="" style="width:100%;height:100%;object-fit:cover"></div>
      </div>

      <!-- ring -->
      <div class="ring" role="img" aria-label="confidence ring">
        <svg width="140" height="140" viewBox="0 0 120 120" aria-hidden="true">
          <circle class="bg-ring" cx="60" cy="60" r="52"></circle>
          <circle id="progressCircle" class="fg-ring" cx="60" cy="60" r="52" stroke-dasharray="326.7256" stroke-dashoffset="326.7256"></circle>
        </svg>
        <div class="percent" id="ringPercent">--%</div>
      </div>

      <div style="margin-top:10px;color:#8a94ad;font-size:13px">Analyzing signal…</div>
      <div style="margin-top:4px;color:#58607a;font-size:12px">Processing market data</div>

      <div class="indicators" id="indicatorsList" aria-hidden="false">
        <!-- chips injected by JS -->
      </div>

      <button class="btn-primary" id="generateBtn">⚡ Generate New Signal</button>
      <button class="btn-ghost" id="backBtn">← Back to Pairs</button>

      <div class="powered">Powered by Advanced AI</div>

      <!-- arrow overlay shown only when signal displayed -->
      <div class="arrow-overlay" id="arrowOverlay" aria-hidden="true">
        <div class="arrow-up" id="arrowUp" style="display:none">
          <!-- rounded neon arrow (type 1) -->
          <svg viewBox="0 0 100 60" width="180" height="120" xmlns="http://www.w3.org/2000/svg">
            <path id="arrowPath" d="M12 42 C30 22, 46 26, 58 36 C70 46, 86 10, 94 6" stroke="#41f08a" stroke-width="10" stroke-linecap="round" stroke-linejoin="round" fill="none" />
            <path d="M92 8 L98 14 L84 16" stroke="#41f08a" stroke-width="6" stroke-linecap="round" stroke-linejoin="round" fill="none" />
          </svg>
        </div>
        <div class="arrow-down" id="arrowDown" style="display:none">
          <svg viewBox="0 0 100 60" width="180" height="120" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 18 C30 38, 46 32, 58 22 C70 12, 86 48, 94 52" stroke="#ff6b6b" stroke-width="10" stroke-linecap="round" stroke-linejoin="round" fill="none" />
            <path d="M92 50 L98 44 L84 42" stroke="#ff6b6b" stroke-width="6" stroke-linecap="round" stroke-linejoin="round" fill="none" />
          </svg>
        </div>
      </div>

      <div class="signal-label" id="signalLabel">Your signal is <span id="signalText">—</span></div>

      <!-- admin debug (hidden by default) -->
      <div id="adminPanel" class="admin-panel" style="display:none" aria-hidden="true">
        <h4>ADMIN DEBUG</h4>
        <div class="admin-row"><div class="admin-key">Final Signal</div><div id="admSignal" class="admin-val">—</div></div>
        <div class="admin-row"><div class="admin-key">Confidence</div><div id="admConfidence" class="admin-val">—</div></div>
        <div class="admin-row"><div class="admin-key">Strength</div><div id="admStrength" class="admin-val">—</div></div>
        <div style="margin-top:8px;font-weight:800;color:#9aa4bd">Indicator Breakdown</div>
        <div id="admIndicators" style="margin-top:8px"></div>

        <div style="margin-top:10px;display:flex;align-items:center;justify-content:space-between">
          <div style="font-size:13px;color:#9aa4bd;font-weight:700">Allow users to see signals</div>
          <label class="toggle">
            <input type="checkbox" id="showUsersToggle">
            <span class="knob"><span class="dot"></span></span>
          </label>
        </div>

        <div style="margin-top:8px;font-size:12px;color:#7a86a8">
          Toggle ON to let non-admins generate signals (no subscription required). Toggle OFF to force subscription modal for non-admins.
        </div>
      </div>
    </div>
  </div>

  <!-- subscription modal -->
  <div class="modal" id="subModal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="box" id="modalBox">
      <h3 id="modalTitle">Subscription Required</h3>
      <p id="modalText">
        To generate live AI trading signals you must activate a subscription through our official Telegram bot. Subscribing gives you verified access to real-time signals, push notifications, and automated trade execution options.
      </p>

      <div class="actions" id="modalActions">
        <a class="tg" id="tgLink" href="https://t.me/Trade_Algo_Robot?start=tradealgo_sub" target="_blank" rel="noopener noreferrer" style="background:linear-gradient(90deg,#5f2bff,#9a4dff); color:#fff; padding:10px; border-radius:10px; text-decoration:none; font-weight:800;">Open Telegram Bot</a>
        <button class="check" id="iSubscribedBtn" style="background:#0a0f15;color:#9ff0c7;border:1px solid rgba(255,255,255,0.03);padding:10px;border-radius:10px;">I Subscribed</button>
      </div>

      <div id="pendingArea" style="display:none;margin-top:12px">
        <div style="padding:12px;border-radius:12px;background: linear-gradient(180deg,#071028,#071022);border:1px solid rgba(255,255,255,0.02);color:#c8d2e6;text-align:left">
          <p><strong>Upload proof of payment inside our Telegram bot.</strong></p>
          <p style="color:#9aa4bd;font-size:13px">After you send the screenshot or receipt in Telegram, our support will verify the payment and activate your access. This page will unlock when verification is complete.</p>
          <div style="display:flex;gap:8px;margin-top:10px">
            <button id="waitingBtn" class="btn-ghost disabled" style="flex:1">Waiting for verification…</button>
            <button id="cancelPending" class="btn-ghost" style="flex:1">Cancel</button>
          </div>
          <p style="margin-top:10px;color:#7a86a8;font-size:12px">Support can either redirect you back with <code>?verified=1</code> or activate server-side.</p>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  // small helpers
  const qs = n => new URLSearchParams(location.search).get(n);

  // params
  const rawPair = qs('pair') || 'EURUSD';
  const tf = qs('tf') || '5s';
  const flag1 = qs('flag1') || '';
  const flag2 = qs('flag2') || '';
  const ADMIN_KEY = 'CipherDev12$'; // your admin key

  // UI refs
  const pairTitleEl = document.getElementById('pairTitle');
  const pairMetaEl = document.getElementById('pairMeta');
  const flag1Img = document.getElementById('flag1Img');
  const flag2Img = document.getElementById('flag2Img');
  const generateBtn = document.getElementById('generateBtn');
  const backBtn = document.getElementById('backBtn');
  const subModal = document.getElementById('subModal');
  const iSubBtn = document.getElementById('iSubscribedBtn');
  const modalActions = document.getElementById('modalActions');
  const pendingArea = document.getElementById('pendingArea');
  const waitingBtn = document.getElementById('waitingBtn');
  const cancelPending = document.getElementById('cancelPending');

  const progressCircle = document.getElementById('progressCircle');
  const ringPercent = document.getElementById('ringPercent');
  const indicatorsList = document.getElementById('indicatorsList');

  const arrowOverlay = document.getElementById('arrowOverlay');
  const arrowUp = document.getElementById('arrowUp');
  const arrowDown = document.getElementById('arrowDown');
  const signalLabel = document.getElementById('signalLabel');
  const signalText = document.getElementById('signalText');

  const adminPanel = document.getElementById('adminPanel');
  const admSignal = document.getElementById('admSignal');
  const admConfidence = document.getElementById('admConfidence');
  const admStrength = document.getElementById('admStrength');
  const admIndicators = document.getElementById('admIndicators');

  const showUsersToggle = document.getElementById('showUsersToggle');

  function flagUrl(code,size){ if(!code) return ''; return `https://flagcdn.com/w${size}/${code}.png`; }
  function formatPair(p){ return (p && p.length===6) ? p.slice(0,3) + ' / ' + p.slice(3) : p; }

  // apply header info
  pairTitleEl.textContent = `${formatPair(rawPair)} (OTC)`;
  pairMetaEl.textContent = `Live Signal · ${tf} Frame`;
  if(flag1){ flag1Img.src = flagUrl(flag1,40); flag1Img.alt = flag1; document.getElementById('flag1Wrap').style.display='inline-block'; } else document.getElementById('flag1Wrap').style.display='none';
  if(flag2){ flag2Img.src = flagUrl(flag2,40); flag2Img.alt = flag2; document.getElementById('flag2Wrap').style.display='inline-block'; } else document.getElementById('flag2Wrap').style.display='none';

  // admin check (persist via localStorage)
  function isAdmin(){
    // if admin key passed in URL and matches, persist admin flag
    const a = qs('admin') || '';
    if(a === ADMIN_KEY){
      try { localStorage.setItem('tradealgo_admin','1'); } catch(e){}
      return true;
    }
    return localStorage.getItem('tradealgo_admin') === '1';
  }

  // toggle persist (control whether non-admins can see signals)
  function showSignalsForUsers(){
    return localStorage.getItem('tradealgo_show_signals') === '1';
  }
  function setShowSignalsForUsers(v){
    try { localStorage.setItem('tradealgo_show_signals', v ? '1' : '0'); }catch(e){}
  }

  function isVerified(){ return localStorage.getItem('tradealgo_verified') === '1'; }

  // seeded pseudo-random generator
  function seeded(seedString){
    let seed = 0;
    for(let i=0;i<seedString.length;i++) seed = (seed*31 + seedString.charCodeAt(i)) % 1000000;
    return function(min,max){
      seed = (seed * 9301 + 49297) % 233280;
      const v = seed / 233280;
      return min + v*(max-min);
    };
  }

  // indicators + confidence generator
  function makeIndicators(seedStr){
    const r = seeded(seedStr);
    const indicators = {
      MACD: Number(r(-1.6,2.4).toFixed(2)),
      RSI: Math.round(r(30,88)),
      OBV_trend: Number(r(-1,1).toFixed(2)),
      EMA_diff: Number(r(-0.8,1.8).toFixed(2)),
      SAR_delta: Number(r(-0.6,0.9).toFixed(2)),
      Volatility: Number(r(0.6,2.6).toFixed(2)),
      VolumeStrength: Number(r(0.2,1.0).toFixed(2))
    };
    // compute score roughly (same logic as before)
    let score = 0;
    score += Math.max(0, indicators.MACD + 1) * 0.18;
    score += (Math.max(0, indicators.RSI - 40) / 50) * 0.18;
    score += ((indicators.OBV_trend + 1) / 2) * 0.15;
    score += (Math.max(0, indicators.EMA_diff + 0.8) / 2.6) * 0.14;
    score += (Math.max(0, indicators.SAR_delta + 0.6) / 1.5) * 0.12;
    const volScore = 1 - Math.abs(indicators.Volatility - 1.1) / 1.5;
    score += Math.max(0, volScore) * 0.12;
    score += indicators.VolumeStrength * 0.11;
    score = Math.max(0, Math.min(1, score / 1.05));
    const confidence = Math.round((0.79 + score * 0.17) * 100); // 79..96
    return {indicators,score:Number((score*10).toFixed(2)),confidence};
  }

  // render indicator chips
  function renderIndicatorChips(ind){
    indicatorsList.innerHTML = '';
    const mapping = [
      ['Parabolic SAR', ind.SAR_delta],
      ['On Balance Volume', ind.OBV_trend],
      ['MACD', ind.MACD],
      ['RSI', ind.RSI],
      ['EMA Cross', ind.EMA_diff],
      ['Volatility', ind.Volatility],
      ['Volume Strength', ind.VolumeStrength]
    ];
    mapping.forEach(([label,val])=>{
      const btn = document.createElement('button');
      btn.className = 'ind-chip';
      btn.type = 'button';
      btn.innerText = label;
      btn.dataset.val = val;
      btn.title = String(val);
      btn.addEventListener('click', ()=> { btn.classList.toggle('selected'); });
      indicatorsList.appendChild(btn);
    });
  }

  // ring helpers
  function setRingPercent(pct){
    const radius = 52;
    const circumference = 2 * Math.PI * radius;
    const offset = circumference * (1 - pct/100);
    const circle = document.getElementById('progressCircle');
    circle.style.transition = 'stroke-dashoffset 900ms cubic-bezier(.2,.9,.36,1)';
    circle.style.strokeDashoffset = offset;
    ringPercent.textContent = pct + '%';
  }

  // signal decision
  function decideSignalFromIndicators(ind){
    const scoreComposite = (ind.MACD * 1.3) + (ind.OBV_trend * 1.2) + (ind.EMA_diff * 1.0) + ((ind.RSI - 50) / 30);
    return scoreComposite >= 0 ? 'UP' : 'DOWN';
  }

  // show arrow + label
  function showArrow(direction){
    arrowUp.style.display = 'none';
    arrowDown.style.display = 'none';
    signalLabel.className = 'signal-label';
    if(direction === 'UP'){
      arrowUp.style.display = 'block';
      signalLabel.classList.add('up');
      signalText.textContent = 'UP';
    } else {
      arrowDown.style.display = 'block';
      signalLabel.classList.add('down');
      signalText.textContent = 'DOWN';
    }
    arrowOverlay.classList.add('show');
    // small glow animation on arrow path
    const path = document.getElementById('arrowPath');
    if(path){
      path.style.filter = 'drop-shadow(0 12px 30px rgba(65,240,138,0.18))';
    }
    setTimeout(()=>{ arrowOverlay.classList.remove('show'); signalLabel.classList.remove('up','down'); arrowUp.style.display='none'; arrowDown.style.display='none'; if(path) path.style.filter='none'; }, 5400);
  }

  // admin debug render
  function renderAdminDebug(out){
    if(!isAdmin()) return;
    adminPanel.style.display = 'block';
    admSignal.textContent = out.finalSignal;
    admConfidence.textContent = out.confidence + '%';
    admStrength.textContent = out.strength + ' / 10';
    admIndicators.innerHTML = '';
    for(const k in out.indicators){
      const row = document.createElement('div');
      row.style.display='flex'; row.style.justifyContent='space-between'; row.style.padding='6px 0';
      row.innerHTML = `<div style="color:#9aa4bd;font-weight:700">${k}</div><div style="font-weight:800">${out.indicators[k]}</div>`;
      admIndicators.appendChild(row);
    }
    // set toggle UI
    showUsersToggle.checked = showSignalsForUsers();
  }

  // initial state
  const initial = makeIndicators(rawPair + '::' + (new Date()).toISOString().slice(0,16));
  renderIndicatorChips(initial.indicators);
  setRingPercent(initial.confidence);

  // handle generate
  generateBtn.addEventListener('click', ()=>{
    // admin: always allowed
    if(isAdmin()){
      generateBtn.disabled = true;
      generateBtn.textContent = 'Generating...';
      setTimeout(()=>{
        const nowData = makeIndicators(rawPair + '|' + Date.now());
        const finalSignal = decideSignalFromIndicators(nowData.indicators);
        setRingPercent(nowData.confidence);
        renderIndicatorChips(nowData.indicators);
        showArrow(finalSignal);
        renderAdminDebug({ finalSignal, confidence: nowData.confidence, strength: nowData.score, indicators: nowData.indicators });
        try { localStorage.setItem('tradealgo_last_signal', JSON.stringify({pair:rawPair,tf,signal:finalSignal,confidence:nowData.confidence,indicators:nowData.indicators,ts:Date.now()})); }catch(e){}
        generateBtn.textContent = '⚡ Generate New Signal';
        generateBtn.disabled = false;
      }, 850);
      return;
    }

    // non-admin -> check toggle whether users are allowed
    if(showSignalsForUsers()){
      // allow them to see (bypass subscription)
      generateBtn.disabled = true;
      generateBtn.textContent = 'Generating...';
      setTimeout(()=>{
        const nowData = makeIndicators(rawPair + '|' + Date.now());
        const finalSignal = decideSignalFromIndicators(nowData.indicators);
        setRingPercent(nowData.confidence);
        renderIndicatorChips(nowData.indicators);
        showArrow(finalSignal);
        try { localStorage.setItem('tradealgo_last_signal', JSON.stringify({pair:rawPair,tf,signal:finalSignal,confidence:nowData.confidence,indicators:nowData.indicators,ts:Date.now()})); }catch(e){}
        generateBtn.textContent = '⚡ Generate New Signal';
        generateBtn.disabled = false;
      }, 850);
      return;
    }

    // default: show subscription modal to regular users
    subModal.style.display = 'flex';
    subModal.setAttribute('aria-hidden','false');
  });

  backBtn.addEventListener('click', ()=> { window.location.href = 'index.html'; });

  // modal handlers
  iSubBtn.addEventListener('click', ()=>{
    try{ localStorage.setItem('tradealgo_subscribed','pending'); }catch(e){}
    modalActions.style.display = 'none';
    pendingArea.style.display = 'block';
    waitingBtn.classList.add('disabled');
  });

  cancelPending.addEventListener('click', ()=>{
    try{ localStorage.removeItem('tradealgo_subscribed'); }catch(e){}
    pendingArea.style.display = 'none';
    modalActions.style.display = 'flex';
    subModal.style.display = 'none';
    subModal.setAttribute('aria-hidden','true');
  });

  subModal.addEventListener('click', (e)=>{ if(e.target === subModal){ subModal.style.display = 'none'; subModal.setAttribute('aria-hidden','true'); } });

  // admin toggle event
  showUsersToggle.addEventListener('change', (e)=>{
    const val = e.target.checked;
    setShowSignalsForUsers(val);
  });

  // if admin on load render debug
  if(isAdmin()){
    renderAdminDebug({ finalSignal:'—', confidence:initial.confidence, strength:initial.score, indicators: initial.indicators });
  } else {
    adminPanel.style.display = 'none';
  }

  // poll for verified (keeps existing behavior)
  let pollTimer = setInterval(()=>{
    if(isVerified()){
      waitingBtn.classList.remove('disabled');
      waitingBtn.textContent = 'Verified — Ready';
      if(subModal.style.display === 'flex'){
        setTimeout(()=>{ subModal.style.display='none'; subModal.setAttribute('aria-hidden','true'); }, 700);
      }
    }
  }, 1200);
  window.addEventListener('beforeunload', ()=> clearInterval(pollTimer) );

})();
</script>
</body>
</html>
